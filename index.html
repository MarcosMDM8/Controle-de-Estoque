<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5ff;
      padding: 20px;
    }
    h1 {
      color: #4a00e0;
    }
    input, select, button {
      margin: 5px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e6e6ff;
    }
    .excluir {
      color: red;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Controle de Estoque</h1>

  <div>
    <input type="text" id="usuario" placeholder="UsuÃ¡rio">
    <input type="text" id="produto" placeholder="Produto">
    <input type="number" id="quantidade" placeholder="Quantidade">
    <select id="tipo">
      <option value="entrada">Entrada</option>
      <option value="saida">SaÃ­da</option>
    </select>
    <button onclick="registrar()">Registrar</button>
    <strong>Saldo Atual: <span id="saldoAtual">0</span></strong>
  </div>

  <h2>ðŸ“œ HistÃ³rico</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>UsuÃ¡rio</th>
        <th>Produto</th>
        <th>Tipo</th>
        <th>Qtd</th>
        <th>Data</th>
        <th>Saldo</th>
        <th>AÃ§Ã£o</th>
      </tr>
    </thead>
    <tbody id="historico"></tbody>
  </table>

  <script>
    const API_URL = "https://app.nocodb.com/api/v2/tables/m9hu3563ew9nw4g/records";
    const TOKEN = "w3ak8WxoOsXR64HgykZw80kiKGbzY2sKogvOH8id";

    async function carregarHistorico() {
      const res = await fetch(API_URL, {
        headers: { "xc-token": TOKEN }
      });
      const data = await res.json();
      const registros = data.list || [];

      let saldo = 0;
      const tbody = document.getElementById("historico");
      tbody.innerHTML = "";

      registros.forEach((r) => {
        const f = r.fields;
        const qtd = Number(f.quantidade) || 0;
        if (f.tipo === "entrada") saldo += qtd;
        else if (f.tipo === "saida") saldo -= qtd;

        tbody.innerHTML += `
          <tr>
            <td>${r.id}</td>
            <td>${f.usuario}</td>
            <td>${f.produto}</td>
            <td>${f.tipo}</td>
            <td>${f.quantidade}</td>
            <td>${f.data}</td>
            <td>${f.saldoApos}</td>
            <td><span class="excluir" onclick="excluir('${r.id}')">Excluir</span></td>
          </tr>
        `;
      });

      document.getElementById("saldoAtual").textContent = saldo;
    }

    async function registrar() {
      const usuario = document.getElementById("usuario").value;
      const produto = document.getElementById("produto").value;
      const quantidade = Number(document.getElementById("quantidade").value);
      const tipo = document.getElementById("tipo").value;
      const data = new Date().toLocaleString();

      const saldoAtual = document.getElementById("saldoAtual").textContent;
      const novoSaldo = tipo === "entrada"
        ? Number(saldoAtual) + quantidade
        : Number(saldoAtual) - quantidade;

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "xc-token": TOKEN
        },
        body: JSON.stringify({
          fields: {
            usuario,
            produto,
            tipo,
            quantidade,
            data,
            saldoApos: novoSaldo
          }
        })
      });

      if (res.ok) {
        await carregarHistorico();
        document.getElementById("usuario").value = "";
        document.getElementById("produto").value = "";
        document.getElementById("quantidade").value = "";
      } else {
        alert("Erro ao registrar movimentaÃ§Ã£o.");
      }
    }

    async function excluir(id) {
      if (!confirm("Deseja excluir este registro?")) return;

      const res = await fetch(`${API_URL}/${id}`, {
        method: "DELETE",
        headers: {
          "xc-token": TOKEN
        }
      });

      if (res.ok) {
        await carregarHistorico();
      } else {
        alert("Erro ao excluir.");
      }
    }

    carregarHistorico();
  </script>
</body>
</html>
