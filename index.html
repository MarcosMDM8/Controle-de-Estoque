<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .entrada { color: #22c55e; font-weight: bold; }
    .saida { color: #ef4444; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <div class="max-w-6xl mx-auto p-6 shadow-xl bg-white rounded-xl mt-10">
    <h1 class="text-3xl font-bold text-center text-indigo-600 flex items-center justify-center gap-2 mb-6">
      üì¶ Sistema de Controle de Estoque
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
      <input id="usuario" class="border p-2 rounded-md col-span-1" type="text" placeholder="Nome do Usu√°rio" />
      <input id="produto" class="border p-2 rounded-md col-span-1" type="text" placeholder="Produto" />
      <input id="quantidade" class="border p-2 rounded-md col-span-1" type="number" placeholder="Quantidade" />
      <select id="tipo" class="border p-2 rounded-md col-span-1">
        <option value="entrada">Entrada</option>
        <option value="saida">Sa√≠da</option>
      </select>
      <button onclick="registrarMovimentacao(true)" class="bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 col-span-1">
        Registrar
      </button>
    </div>

    <div class="text-center font-bold text-lg mb-6">Saldo Atual: <span id="saldoTotal" class="text-indigo-700">0</span></div>

    <div class="mb-4">
      <h2 class="text-xl font-semibold text-blue-700 mb-2">üîç Pesquisar Movimenta√ß√µes</h2>
      <div class="flex gap-2">
        <input id="pesquisaProduto" class="border p-2 rounded-md w-full" type="text" placeholder="Digite o nome do produto" />
        <button onclick="pesquisarMovimentacoes()" class="bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700">
          Pesquisar
        </button>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold text-purple-700 mb-2">üìÑ Hist√≥rico de Movimenta√ß√µes</h2>
      <table class="w-full table-auto text-sm text-center shadow-sm bg-gray-100 rounded-md">
        <thead class="bg-indigo-100">
          <tr>
            <th class="p-2">Usu√°rio</th>
            <th class="p-2">Produto</th>
            <th class="p-2">Tipo</th>
            <th class="p-2">Quantidade</th>
            <th class="p-2">Data</th>
            <th class="p-2">Saldo Ap√≥s</th>
            <th class="p-2">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="historicoBody" class="bg-white"></tbody>
      </table>
    </div>

    <div>
      <h2 class="text-xl font-semibold text-yellow-600 mb-2">üì¶ Resumo do Estoque</h2>
      <table class="w-full table-auto text-sm text-center shadow-sm bg-gray-100 rounded-md">
        <thead class="bg-yellow-100">
          <tr>
            <th class="p-2">Produto</th>
            <th class="p-2">Quantidade Total</th>
          </tr>
        </thead>
        <tbody id="resumoEstoque" class="bg-white"></tbody>
      </table>
    </div>
  </div>

  <script>
    const apiBase = "https://app.nocodb.com/api/v2/tables/m9hu3563ew9nw4g/records";
    const apiToken = "SEU_TOKEN_AQUI"; // <-- substitua aqui pelo seu token real
    let historico = [];
    let estoque = {};
    let saldo = 0;

    function gerarId() {
      return Math.floor(Math.random() * 1000000).toString();
    }

    function carregarDados() {
      fetch(`${apiBase}?offset=0&limit=100`, {
        headers: {
          "xc-token": apiToken
        }
      })
      .then(res => res.json())
      .then(json => {
        const data = json.list || [];
        historico = data.map(row => ({
          id: row.Id,
          usuario: row.Usuario,
          produto: row.Produto,
          tipo: row.Tipo,
          quantidade: parseInt(row.Quantidade),
          data: row.Data,
          saldoApos: parseInt(row.SaldoApos)
        }));
        recalcularSaldos();
        atualizarHistorico();
        atualizarResumoEstoque();
      })
      .catch(err => console.error("Erro ao carregar dados:", err));
    }

    function registrarMovimentacao(salvarNaApi = false) {
      const usuario = document.getElementById('usuario').value.trim();
      const produto = document.getElementById('produto').value.trim();
      const quantidade = parseInt(document.getElementById('quantidade').value);
      const tipo = document.getElementById('tipo').value;

      if (!usuario || !produto || isNaN(quantidade) || quantidade <= 0) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      const data = new Date().toLocaleString('pt-BR');
      const id = gerarId();
      const novoRegistro = { id, usuario, produto, tipo, quantidade, data };

      if (!estoque[produto]) estoque[produto] = 0;
      novoRegistro.saldoApos = tipo === "entrada" ? estoque[produto] + quantidade : estoque[produto] - quantidade;

      if (salvarNaApi) {
        fetch(apiBase, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "xc-token": apiToken
          },
          body: JSON.stringify({
            Usuario: usuario,
            Produto: produto,
            Tipo: tipo,
            Quantidade: quantidade,
            Data: data,
            SaldoApos: novoRegistro.saldoApos
          })
        })
        .then(() => {
          historico.push(novoRegistro);
          recalcularSaldos();
          atualizarHistorico();
          atualizarResumoEstoque();
          limparCampos();
        })
        .catch(() => alert("Erro ao registrar movimenta√ß√£o"));
      }
    }

    function recalcularSaldos() {
      estoque = {};
      saldo = 0;
      historico.forEach(item => {
        if (!estoque[item.produto]) estoque[item.produto] = 0;
        estoque[item.produto] += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        saldo += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        item.saldoApos = estoque[item.produto];
      });
      document.getElementById('saldoTotal').textContent = saldo;
    }

    function atualizarHistorico(filtro = "") {
      const tbody = document.getElementById('historicoBody');
      tbody.innerHTML = "";
      historico.forEach((item, index) => {
        if (!filtro || item.produto.toLowerCase().includes(filtro.toLowerCase())) {
          const row = `
            <tr>
              <td class="p-2">${item.usuario}</td>
              <td class="p-2">${item.produto}</td>
              <td class="p-2 ${item.tipo}">${item.tipo}</td>
              <td class="p-2">${item.quantidade}</td>
              <td class="p-2">${item.data}</td>
              <td class="p-2">${item.saldoApos}</td>
              <td class="p-2">
                <button onclick="deletarRegistro('${item.id}', ${index})" class="text-red-500 hover:underline">Excluir</button>
              </td>
            </tr>`;
          tbody.innerHTML += row;
        }
      });
    }

    function atualizarResumoEstoque() {
      const tbody = document.getElementById('resumoEstoque');
      tbody.innerHTML = "";
      for (let produto in estoque) {
        tbody.innerHTML += `
          <tr>
            <td class="p-2">${produto}</td>
            <td class="p-2">${estoque[produto]}</td>
          </tr>`;
      }
    }

    function pesquisarMovimentacoes() {
      const termo = document.getElementById('pesquisaProduto').value.trim().toLowerCase();
      atualizarHistorico(termo);
    }

    function deletarRegistro(id, index) {
      if (!confirm("Deseja excluir esse registro?")) return;
      fetch(`${apiBase}/${id}`, {
        method: "DELETE",
        headers: {
          "xc-token": apiToken
        }
      })
      .then(() => {
        historico.splice(index, 1);
        recalcularSaldos();
        atualizarHistorico();
        atualizarResumoEstoque();
      })
      .catch(() => alert("Erro ao excluir"));
    }

    function limparCampos() {
      document.getElementById('usuario').value = "";
      document.getElementById('produto').value = "";
      document.getElementById('quantidade').value = "";
      document.getElementById('tipo').value = "entrada";
    }

    window.onload = carregarDados;
  </script>
</body>
</html>
