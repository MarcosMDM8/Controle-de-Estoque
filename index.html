<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Controle de Estoque</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <input id="usuario" class="p-3 border rounded" placeholder="Usuário">
      <input id="produto" class="p-3 border rounded" placeholder="Produto">
      <input id="quantidade" type="number" class="p-3 border rounded" placeholder="Quantidade">
      <select id="tipo" class="p-3 border rounded">
        <option value="entrada">Entrada</option>
        <option value="saida">Saída</option>
      </select>
    </div>

    <div class="flex justify-between mb-6">
      <button onclick="registrarMovimentacao()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Registrar</button>
      <input id="pesquisaProduto" oninput="pesquisarMovimentacoes()" class="p-3 border rounded w-64" placeholder="Pesquisar Produto">
    </div>

    <h2 class="text-xl font-semibold mb-2">Histórico de Movimentações</h2>
    <div class="overflow-x-auto mb-6">
      <table class="w-full table-auto border text-sm text-left">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3">ID</th>
            <th class="p-3">Usuário</th>
            <th class="p-3">Produto</th>
            <th class="p-3">Tipo</th>
            <th class="p-3">Quantidade</th>
            <th class="p-3">Data</th>
            <th class="p-3">Saldo Após</th>
            <th class="p-3">Ações</th>
          </tr>
        </thead>
        <tbody id="historicoBody"></tbody>
      </table>
    </div>

    <h2 class="text-xl font-semibold mb-2">Resumo do Estoque</h2>
    <div class="overflow-x-auto">
      <table class="w-full table-auto border text-sm text-left">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3">Produto</th>
            <th class="p-3">Saldo Atual</th>
          </tr>
        </thead>
        <tbody id="resumoEstoque"></tbody>
      </table>
    </div>

    <div class="mt-6 text-right">
      <strong>Saldo Total de Itens:</strong> <span id="saldoTotal">0</span>
    </div>
  </div>

  <script>
    const API_URL = "https://api.sheetson.com/v2/sheets/Página1";
    const API_TOKEN = "IXhHEyqFQ-EkdhQgKcCoJX9WVl_tbp3CSr8-iReAE-q3fPb-dpbbvgSkaaM";

    let historico = [];
    let estoque = {};
    let saldo = 0;

    async function carregarDados() {
      try {
        const response = await fetch(API_URL, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`,
            "Content-Type": "application/json"
          }
        });
        const data = await response.json();
        historico = data.results.map(doc => ({
          id: doc.id,
          usuario: doc.usuario,
          produto: doc.produto,
          tipo: doc.tipo,
          quantidade: parseInt(doc.quantidade),
          data: doc.data,
          saldoApos: parseInt(doc.saldoApos)
        }));
        recalcularSaldos();
        atualizarHistorico();
        atualizarResumoEstoque();
      } catch (err) {
        console.error("Erro ao carregar:", err);
        alert("Erro ao carregar dados");
      }
    }

    async function registrarMovimentacao() {
      const usuario = document.getElementById("usuario").value.trim();
      const produto = document.getElementById("produto").value.trim();
      const quantidade = parseInt(document.getElementById("quantidade").value);
      const tipo = document.getElementById("tipo").value;

      if (!usuario || !produto || isNaN(quantidade) || quantidade <= 0) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      const data = new Date().toLocaleString("pt-BR");
      const saldoProduto = (estoque[produto] || 0) + (tipo === "entrada" ? quantidade : -quantidade);
      const novo = {
        usuario,
        produto,
        tipo,
        quantidade,
        data,
        saldoApos: saldoProduto
      };

      try {
        await fetch(API_URL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${API_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(novo)
        });
        carregarDados();
        limparCampos();
      } catch (err) {
        console.error("Erro ao registrar:", err);
        alert("Erro ao registrar movimentação");
      }
    }

    async function deletarMovimentacao(id) {
      if (!confirm("Tem certeza que deseja excluir esta movimentação?")) return;

      try {
        await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${API_TOKEN}`,
            "Content-Type": "application/json"
          }
        });
        carregarDados();
      } catch (err) {
        console.error("Erro ao excluir:", err);
        alert("Erro ao excluir movimentação");
      }
    }

    function recalcularSaldos() {
      estoque = {};
      saldo = 0;
      historico.forEach(item => {
        if (!estoque[item.produto]) estoque[item.produto] = 0;
        estoque[item.produto] += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        saldo += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        item.saldoApos = estoque[item.produto];
      });
      document.getElementById("saldoTotal").textContent = saldo;
    }

    function atualizarHistorico(filtro = "") {
      const tbody = document.getElementById("historicoBody");
      tbody.innerHTML = "";
      historico.forEach(item => {
        if (!filtro || item.produto.toLowerCase().includes(filtro)) {
          tbody.innerHTML += `
            <tr>
              <td class="p-3">${item.id}</td>
              <td class="p-3">${item.usuario}</td>
              <td class="p-3">${item.produto}</td>
              <td class="p-3 ${item.tipo}">${item.tipo}</td>
              <td class="p-3">${item.quantidade}</td>
              <td class="p-3">${item.data}</td>
              <td class="p-3">${item.saldoApos}</td>
              <td class="p-3">
                <button onclick="deletarMovimentacao('${item.id}')" class="text-red-600 hover:underline">Excluir</button>
              </td>
            </tr>`;
        }
      });
    }

    function atualizarResumoEstoque() {
      const tbody = document.getElementById("resumoEstoque");
      tbody.innerHTML = "";
      for (let produto in estoque) {
        tbody.innerHTML += `
          <tr>
            <td class="p-3">${produto}</td>
            <td class="p-3">${estoque[produto]}</td>
          </tr>`;
      }
    }

    function pesquisarMovimentacoes() {
      const termo = document.getElementById("pesquisaProduto").value.trim().toLowerCase();
      atualizarHistorico(termo);
    }

    function limparCampos() {
      document.getElementById("usuario").value = "";
      document.getElementById("produto").value = "";
      document.getElementById("quantidade").value = "";
      document.getElementById("tipo").value = "entrada";
    }

    window.onload = carregarDados;
  </script>
</body>
</html>
