<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .entrada { color: #16a34a; font-weight: bold; }
    .saida { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body class="bg-gradient-to-r from-indigo-50 to-purple-100 min-h-screen p-6 font-sans text-gray-800">
  <div class="max-w-6xl mx-auto p-8 bg-white shadow-2xl rounded-2xl">
    <h1 class="text-4xl font-bold text-center text-indigo-700 mb-10">游닍 Controle de Estoque</h1>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <input id="usuario" class="border p-3 rounded-xl col-span-1" type="text" placeholder="Usu치rio" />
      <input id="produto" class="border p-3 rounded-xl col-span-1" type="text" placeholder="Produto" />
      <input id="quantidade" class="border p-3 rounded-xl col-span-1" type="number" placeholder="Quantidade" />
      <select id="tipo" class="border p-3 rounded-xl col-span-1">
        <option value="entrada">Entrada</option>
        <option value="saida">Sa칤da</option>
      </select>
      <button onclick="registrarMovimentacao()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition">Registrar</button>
    </div>

    <div class="text-center text-xl font-semibold mb-8">Saldo Atual: <span id="saldoTotal" class="text-indigo-700">0</span></div>

    <div class="mb-6">
      <h2 class="text-2xl font-semibold text-blue-700 mb-3">游댌 Pesquisar Produto</h2>
      <div class="flex gap-2">
        <input id="pesquisaProduto" class="border p-3 rounded-xl w-full" type="text" placeholder="Buscar produto" />
        <button onclick="pesquisarMovimentacoes()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">Pesquisar</button>
      </div>
    </div>

    <div class="mb-10">
      <h2 class="text-2xl font-semibold text-purple-700 mb-3">游늯 Hist칩rico</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-sm text-center bg-white shadow rounded-xl">
          <thead class="bg-indigo-100">
            <tr>
              <th class="p-3">ID</th>
              <th class="p-3">Usu치rio</th>
              <th class="p-3">Produto</th>
              <th class="p-3">Tipo</th>
              <th class="p-3">Qtd</th>
              <th class="p-3">Data</th>
              <th class="p-3">Saldo</th>
            </tr>
          </thead>
          <tbody id="historicoBody" class="bg-white"></tbody>
        </table>
      </div>
    </div>

    <div>
      <h2 class="text-2xl font-semibold text-yellow-600 mb-3">游닍 Resumo do Estoque</h2>
      <table class="w-full table-auto text-sm text-center bg-white shadow rounded-xl">
        <thead class="bg-yellow-100">
          <tr>
            <th class="p-3">Produto</th>
            <th class="p-3">Quantidade</th>
          </tr>
        </thead>
        <tbody id="resumoEstoque" class="bg-white"></tbody>
      </table>
    </div>
  </div>

  <script>
    const apiBase = "https://app.nocodb.com/api/v2/tables/vw2q36yj7ulcra84/records";
    const apiToken = "w3ak8WxoOsXR64HgykZw80kiKGbzY2sKogvOH8id";

    function registrarMovimentacao() {
      const usuario = document.getElementById('usuario').value;
      const produto = document.getElementById('produto').value;
      const quantidade = parseInt(document.getElementById('quantidade').value);
      const tipo = document.getElementById('tipo').value;
      const data = new Date().toLocaleString();

      if (!usuario || !produto || isNaN(quantidade)) {
        alert("Preencha todos os campos!");
        return;
      }

      const body = {
        Usuario: usuario,
        Produto: produto,
        Tipo: tipo,
        Quantidade: quantidade,
        Data: data,
        SaldoApos: 0 // ser치 atualizado depois
      };

      fetch(apiBase, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "xc-token": apiToken
        },
        body: JSON.stringify({ fields: body })
      })
      .then(res => res.json())
      .then(() => {
        alert("Movimenta칞칚o registrada com sucesso!");
        location.reload();
      })
      .catch(err => alert("Erro ao registrar: " + err));
    }

    function carregarHistorico() {
      fetch(apiBase, {
        headers: { "xc-token": apiToken }
      })
      .then(res => res.json())
      .then(json => {
        const historico = json.list;
        let saldo = 0;
        const estoque = {};
        const historicoHTML = historico.map((item, i) => {
          const qtd = parseInt(item.Quantidade);
          const isEntrada = item.Tipo === "entrada";
          saldo += isEntrada ? qtd : -qtd;
          item.SaldoApos = saldo;

          if (!estoque[item.Produto]) estoque[item.Produto] = 0;
          estoque[item.Produto] += isEntrada ? qtd : -qtd;

          return `<tr>
            <td class="p-2">${i + 1}</td>
            <td class="p-2">${item.Usuario}</td>
            <td class="p-2">${item.Produto}</td>
            <td class="p-2 ${isEntrada ? 'entrada' : 'saida'}">${item.Tipo}</td>
            <td class="p-2">${qtd}</td>
            <td class="p-2">${item.Data}</td>
            <td class="p-2">${item.SaldoApos}</td>
          </tr>`;
        }).join("");

        document.getElementById("historicoBody").innerHTML = historicoHTML;
        document.getElementById("saldoTotal").textContent = saldo;

        const resumoHTML = Object.entries(estoque).map(([produto, qtd]) => `<tr>
          <td class="p-2">${produto}</td>
          <td class="p-2">${qtd}</td>
        </tr>`).join("");

        document.getElementById("resumoEstoque").innerHTML = resumoHTML;
      });
    }

    window.onload = carregarHistorico;
  </script>
</body>
</html>
