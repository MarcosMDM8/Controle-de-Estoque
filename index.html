<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/browser/appwrite.min.js"></script>
  <style>
    .entrada { color: #16a34a; font-weight: bold; }
    .saida { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body class="bg-gradient-to-r from-indigo-50 to-purple-100 min-h-screen p-6 font-sans text-gray-800">
  <div class="max-w-6xl mx-auto p-8 bg-white shadow-2xl rounded-2xl">
    <h1 class="text-4xl font-bold text-center text-indigo-700 mb-10">üì¶ Controle de Estoque</h1>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <input id="usuario" class="border p-3 rounded-xl col-span-1" type="text" placeholder="Usu√°rio" />
      <input id="produto" class="border p-3 rounded-xl col-span-1" type="text" placeholder="Produto" />
      <input id="quantidade" class="border p-3 rounded-xl col-span-1" type="number" placeholder="Quantidade" />
      <select id="tipo" class="border p-3 rounded-xl col-span-1">
        <option value="entrada">Entrada</option>
        <option value="saida">Sa√≠da</option>
      </select>
      <button onclick="registrarMovimentacao()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition">Registrar</button>
    </div>

    <div class="text-center text-xl font-semibold mb-8">Saldo Atual: <span id="saldoTotal" class="text-indigo-700">0</span></div>

    <div class="mb-6">
      <h2 class="text-2xl font-semibold text-blue-700 mb-3">üîç Pesquisar Produto</h2>
      <div class="flex gap-2">
        <input id="pesquisaProduto" class="border p-3 rounded-xl w-full" type="text" placeholder="Buscar produto" />
        <button onclick="pesquisarMovimentacoes()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">Pesquisar</button>
      </div>
    </div>

    <div class="mb-10">
      <h2 class="text-2xl font-semibold text-purple-700 mb-3">üìÑ Hist√≥rico</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-sm text-center bg-white shadow rounded-xl">
          <thead class="bg-indigo-100">
            <tr>
              <th class="p-3">ID</th>
              <th class="p-3">Usu√°rio</th>
              <th class="p-3">Produto</th>
              <th class="p-3">Tipo</th>
              <th class="p-3">Qtd</th>
              <th class="p-3">Data</th>
              <th class="p-3">Saldo</th>
              <th class="p-3">A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="historicoBody" class="bg-white"></tbody>
        </table>
      </div>
    </div>

    <div>
      <h2 class="text-2xl font-semibold text-yellow-600 mb-3">üì¶ Resumo do Estoque</h2>
      <table class="w-full table-auto text-sm text-center bg-white shadow rounded-xl">
        <thead class="bg-yellow-100">
          <tr>
            <th class="p-3">Produto</th>
            <th class="p-3">Quantidade</th>
          </tr>
        </thead>
        <tbody id="resumoEstoque" class="bg-white"></tbody>
      </table>
    </div>
  </div>

  <script>
    const client = new window.Appwrite.Client();
    client
      .setEndpoint('https://cloud.appwrite.io/v1')
      .setProject('67f855200037658b5cff')
      .setKey('standard_7e029b38dbb29173888a87e770b0a08ff6d0fce8d0a6fd93dc75572431f7d95120ea7ce67ad4d64e3405301209b99484da4daf3426344934a70f6bbe39c2ef74351e5f027d31f5147f221a6359083956615ec200e4773a214ae16815721e5df9f7c3cc9079966ec2dd60a8e8837ea612672a82c6c2633e523eab54264e1afd14');

    const databases = new window.Appwrite.Databases(client);
    const databaseId = '67f855200037658b5cff';
    const collectionId = '67f8556e00195818cd15';

    let historico = [];
    let estoque = {};
    let saldo = 0;

    async function carregarDados() {
      try {
        const response = await databases.listDocuments(databaseId, collectionId);
        historico = response.documents.map(doc => ({
          id: doc.$id,
          usuario: doc.usuario,
          produto: doc.produto,
          tipo: doc.tipo,
          quantidade: doc.quantidade,
          data: doc.data,
          saldoApos: doc.saldoApos
        }));
        recalcularSaldos();
        atualizarHistorico();
        atualizarResumoEstoque();
      } catch (err) {
        console.error('Erro ao carregar:', err);
        alert('Erro ao carregar dados');
      }
    }

    async function registrarMovimentacao() {
      const usuario = document.getElementById('usuario').value.trim();
      const produto = document.getElementById('produto').value.trim();
      const quantidade = parseInt(document.getElementById('quantidade').value);
      const tipo = document.getElementById('tipo').value;
      if (!usuario || !produto || isNaN(quantidade) || quantidade <= 0) {
        alert("Preencha todos os campos corretamente.");
        return;
      }
      const data = new Date().toLocaleString('pt-BR');
      const saldoProduto = (estoque[produto] || 0) + (tipo === "entrada" ? quantidade : -quantidade);
      const novo = { usuario, produto, tipo, quantidade, data, saldoApos: saldoProduto };

      try {
        await databases.createDocument(databaseId, collectionId, 'unique()', novo);
        carregarDados();
        limparCampos();
      } catch (err) {
        console.error('Erro ao registrar:', err);
        alert('Erro ao registrar movimenta√ß√£o');
      }
    }

    async function deletarMovimentacao(id) {
      if (!confirm("Tem certeza que deseja excluir esta movimenta√ß√£o?")) return;
      try {
        await databases.deleteDocument(databaseId, collectionId, id);
        carregarDados();
      } catch (err) {
        console.error("Erro ao excluir:", err);
        alert("Erro ao excluir movimenta√ß√£o");
      }
    }

    function recalcularSaldos() {
      estoque = {}; saldo = 0;
      historico.forEach(item => {
        if (!estoque[item.produto]) estoque[item.produto] = 0;
        estoque[item.produto] += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        saldo += item.tipo === "entrada" ? item.quantidade : -item.quantidade;
        item.saldoApos = estoque[item.produto];
      });
      document.getElementById('saldoTotal').textContent = saldo;
    }

    function atualizarHistorico(filtro = "") {
      const tbody = document.getElementById('historicoBody');
      tbody.innerHTML = "";
      historico.forEach((item) => {
        if (!filtro || item.produto.toLowerCase().includes(filtro)) {
          tbody.innerHTML += `
            <tr>
              <td class="p-3">${item.id}</td>
              <td class="p-3">${item.usuario}</td>
              <td class="p-3">${item.produto}</td>
              <td class="p-3 ${item.tipo}">${item.tipo}</td>
              <td class="p-3">${item.quantidade}</td>
              <td class="p-3">${item.data}</td>
              <td class="p-3">${item.saldoApos}</td>
              <td class="p-3">
                <button onclick="deletarMovimentacao('${item.id}')" class="text-red-600 hover:underline">Excluir</button>
              </td>
            </tr>`;
        }
      });
    }

    function atualizarResumoEstoque() {
      const tbody = document.getElementById('resumoEstoque');
      tbody.innerHTML = "";
      for (let produto in estoque) {
        tbody.innerHTML += `
          <tr>
            <td class="p-3">${produto}</td>
            <td class="p-3">${estoque[produto]}</td>
          </tr>`;
      }
    }

    function pesquisarMovimentacoes() {
      const termo = document.getElementById('pesquisaProduto').value.trim().toLowerCase();
      atualizarHistorico(termo);
    }

    function limparCampos() {
      document.getElementById('usuario').value = "";
      document.getElementById('produto').value = "";
      document.getElementById('quantidade').value = "";
      document.getElementById('tipo').value = "entrada";
    }

    window.onload = carregarDados;
  </script>
</body>
</html>
