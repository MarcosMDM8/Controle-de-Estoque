<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Estoque</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f3f4f6; padding: 2rem; }
    h1 { color: #4f46e5; }
    input, select, button {
      padding: 0.5rem;
      margin: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button { background: #4f46e5; color: white; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td {
      border: 1px solid #ddd; padding: 0.75rem; text-align: center;
    }
    th { background: #e0e7ff; }
    .excluir { color: red; cursor: pointer; }
  </style>
</head>
<body>

  <h1>游닍 Controle de Estoque</h1>

  <div>
    <input id="usuario" placeholder="Usu치rio" />
    <input id="produto" placeholder="Produto" />
    <input id="quantidade" type="number" placeholder="Quantidade" />
    <select id="tipo">
      <option value="entrada">Entrada</option>
      <option value="saida">Sa칤da</option>
    </select>
    <button onclick="registrar()">Registrar</button>
  </div>

  <p><strong>Saldo Atual:</strong> <span id="saldoAtual">0</span></p>

  <h2>游닆 Hist칩rico</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Usu치rio</th>
        <th>Produto</th>
        <th>Tipo</th>
        <th>Qtd</th>
        <th>Data</th>
        <th>Saldo</th>
        <th>A칞칚o</th>
      </tr>
    </thead>
    <tbody id="historico"></tbody>
  </table>

  <script>
    const API_URL = "https://app.nocodb.com/api/v2/tables/m9hu3563ew9nw4g/records";
    const TOKEN = "w3ak8WxoOsXR64HgykZw80kiKGbzY2sKogvOH8id";

    async function carregarHistorico() {
      const res = await fetch(API_URL, {
        headers: { "xc-token": TOKEN }
      });
      const dados = await res.json();
      const registros = dados.list || [];
      const tbody = document.getElementById("historico");
      tbody.innerHTML = "";

      let saldo = 0;
      registros.forEach((r) => {
        const qtd = Number(r.quantidade) || 0;
        if (r.tipo === "entrada") saldo += qtd;
        else if (r.tipo === "saida") saldo -= qtd;

        tbody.innerHTML += `
          <tr>
            <td>${r.id}</td>
            <td>${r.usuario}</td>
            <td>${r.produto}</td>
            <td>${r.tipo}</td>
            <td>${r.quantidade}</td>
            <td>${r.data}</td>
            <td>${r.saldoApos}</td>
            <td><span class="excluir" onclick="excluir(${r.id})">Excluir</span></td>
          </tr>
        `;
      });

      document.getElementById("saldoAtual").textContent = saldo;
    }

    async function registrar() {
      const usuario = document.getElementById("usuario").value;
      const produto = document.getElementById("produto").value;
      const quantidade = Number(document.getElementById("quantidade").value);
      const tipo = document.getElementById("tipo").value;
      const data = new Date().toLocaleString();

      // Buscar hist칩rico atual para calcular saldo
      const res = await fetch(API_URL, {
        headers: { "xc-token": TOKEN }
      });
      const dados = await res.json();
      const historico = dados.list || [];

      let saldo = 0;
      historico.forEach((r) => {
        const qtd = Number(r.quantidade) || 0;
        if (r.tipo === "entrada") saldo += qtd;
        else if (r.tipo === "saida") saldo -= qtd;
      });

      // Atualiza saldo com a nova opera칞칚o
      const novoSaldo = tipo === "entrada" ? saldo + quantidade : saldo - quantidade;

      // Enviar novo registro
      await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "xc-token": TOKEN
        },
        body: JSON.stringify({
          usuario,
          produto,
          tipo,
          quantidade,
          data,
          saldoApos: novoSaldo
        })
      });

      // Limpar campos
      document.getElementById("usuario").value = "";
      document.getElementById("produto").value = "";
      document.getElementById("quantidade").value = "";

      carregarHistorico();
    }

    async function excluir(id) {
      if (!confirm("Tem certeza que deseja excluir?")) return;
      await fetch(`${API_URL}/${id}`, {
        method: "DELETE",
        headers: { "xc-token": TOKEN }
      });
      carregarHistorico();
    }

    // Carrega dados ao abrir
    carregarHistorico();
  </script>

</body>
</html>
